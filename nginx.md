在 Ubuntu 下一直没弄好
### 简介
nginx 有 master 进程 和 worker 进程
### 查看 nginx 的相关信息
```
$ whereis nginx
nginx: /usr/sbin/nginx /etc/nginx /usr/share/nginx
```
显示 nginx 的安装地址, 其中 /etc/nginx 是配置文件地址
/etc/nginx/sites-enabled/default 中的 root 就是 nginx 的根目录地址, 可以自己修改
```
server {
	listen 80 default_server;
	listen [::]:80 default_server;

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

	# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php7.0-cgi alone:
	#	fastcgi_pass 127.0.0.1:9000;
	#	# With php7.0-fpm:
	#	fastcgi_pass unix:/run/php/php7.0-fpm.sock;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}
}
```
### 启动 停止 重启
使用默认的 prefix
```
$ nginx
或者比较全的命令是
$ nginx -c /etc/nginx/nginx.conf
```
使用指定的 prefix path
```
$ sudo nginx -p /home/coder352/Documents/thiscandel
```
三种停止方式
```
ps -ef | grep nginx && kill pid  # 停止 master 进程即可
kill -QUIT pid_of_nginx  # 从容停止 nginx
kill -TERM pid_of_nginx  # 快速停止 nginx
kill -INT pid_of_nginx  # 快速停止 nginx
pkill -9 nginx  # 强制停止
sudo nginx -s stop/quit  # 这样也可以停止 nginx
```
修个配置后, 重启前 验证配置文件是否正确
```
sudo nginx -t
```
然后重启
```
sudo nginx -s reload
或者
ps -ef | grep nginx && kill -HUP pid  # 发送信号重启
```
### 信号控制
```
HUP: 重启
QUIT: 从容关闭
TERM: 快速关闭
INT: 从容关闭
USR1: 切换日志文件
USR2: 平滑升级可执行程序
WINCH: 从容关闭工作进程
```
### 平滑升级
略
### 基本配置
#### 文件总览
```
$ whereis nginx
```
/etc/nginx/nginx.conf 就是配置文件
抽象版框架
```
user www-data;
worker_processes auto;
events {
    worker_connections 1024;
}
http {
    server {

    }
    server {

    }
}
```
完整版
```
user www-data;  # 用户是 www-data
worker_processes auto;  # 跟 CPU 核数有关, 工作衍生进程数
pid /run/nginx.pid;  # 控制系统中的重要文件

# 设置最大连接数
events {
	worker_connections 768;
	# multi_accept on;
}

http {

	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	types_hash_max_size 2048;
	# server_tokens off;

	# server_names_hash_bucket_size 64;
	# server_name_in_redirect off;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	##
	# SSL Settings
	##

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE
	ssl_prefer_server_ciphers on;

	##
	# Logging Settings
	##

	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	##
	# Gzip Settings
    # 小于 1K 的文件不适于 gzip 压缩
	##

	gzip on;
    gzip_min_lenth 1k;
	gzip_disable "msie6";

	# gzip_vary on;
	# gzip_proxied any;
	# gzip_comp_level 6;
	# gzip_buffers 16 8k;
	# gzip_http_version 1.1;
	# gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	##
	# Virtual Host Configs
	##

	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;
}


#mail {
#	# See sample authentication script at:
#	# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript
# 
#	# auth_http localhost/auth.php;
#	# pop3_capabilities "TOP" "USER";
#	# imap_capabilities "IMAP4rev1" "UIDPLUS";
# 
#	server {
#		listen     localhost:110;
#		protocol   pop3;
#		proxy      on;
#	}
# 
#	server {
#		listen     localhost:143;
#		protocol   imap;
#		proxy      on;
#	}
#}
```
#### 虚拟主机配置
##### 配置 eth0
```
ifconfig eth0 192.168.1.9 netmask 255.255.255.0
```
##### 配置 eth0 分设备 配置 虚拟主机
```
ifconfig eth0:1 192.168.1.7 broadcast 192.168.1.255 netmask 255.255.255.0
ifconfig eth0:2 192.168.1.17 broadcast 192.168.1.255 netmask 255.255.255.0
下面是自己的实际配置 好像新的 命名不支持 分设备了 systemd的系统的新特性
sudo ifconfig enx00e04c6804e1:1 192.168.1.7 broadcast 192.168.1.255 netmask 255.255.255.0
sudo ifconfig enx00e04c6804e1:2 192.168.1.17 broadcast 192.168.1.255 netmask 255.255.255.0
```
```
$ cd /etc/nginx && touch vps.conf
```
填充框架即可
```
user www-data;
worker_processes auto;
events {
    worker_connections 1024;
}
http {
    server {  # 这里是 vps 配置 
        listen 192.168.1.7:80;
        server_name 192.168.1.7;  # 方便记忆
        access_log /var/log/nginx/error.log combined;
        location /
        {
            index index.html index.htm;  # 两种文件都会被识别为首页文件
            root /var/www/html;  # prefix page
        }
        location ~.*\.(jpg|png|swf|gif)${
            expires 2d;  # 后缀名为 .jpg等 两天清除
        }
        location ~.*\.(css|js)${
            expires 1h;  # 一小时 清楚 css js
        }
    }
    server {
        listen 192.168.1.17:80;
        server_name 192.168.1.17;
        access_log /var/log/nginx/error.log combined;
        location /
        {
            index index.html ;
            root /var/www/html;
        }
    }
}
```
开始测试
```
sudo nginx -c /etc/nginx/vps.conf
curl http://192.168.1.17
```
### PHP 环境搭建
/etc/php/7.0/fpm/php-fpm.conf 备份,重新写
```
$ sudo vim /etc/php/7.0/fpm/php-fpm.conf
$ cd /etc/php/7.0/fpm && cp php-fpm.conf php-fpm.conf.bak
```
```
$ sudo service php-fpm restart
```
/etc/nginx/nginx.conf 补充
```
http {
    location / {
        root   /var/www/html;   # web的根目录
        index  index.php index.html index.htm; # 加入index.php
    }
    location ~\.(php|php5)?$ {
        root   /var/www/html;   # web的根目录
        fastcgi_pass 127.0.0.1:9000;  # php-fpm的地址
        fastcgi_index index.php;
        include fastcgi.conf;
    }
}
```
```
sudo service nginx restart
```
